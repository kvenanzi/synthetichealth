# VistA MUMPS Globals Primer: Understanding VA Healthcare Data Structures

## Overview

VistA (Veterans Health Information Systems and Technology Architecture) uses MUMPS (Massachusetts General Hospital Utility Multi-Programming System) global structures to store healthcare data. This primer explains how to read, understand, and work with VistA MUMPS global files generated by the Synthetic Healthcare Data Generator.

## Table of Contents

1. [What are VistA MUMPS Globals?](#what-are-vista-mumps-globals)
2. [Global Structure and Syntax](#global-structure-and-syntax)
3. [Major VistA Globals](#major-vista-globals)
4. [Reading Global Files](#reading-global-files)
5. [Working with VistA Data](#working-with-vista-data)
6. [Common Global Patterns](#common-global-patterns)
7. [Tools and Utilities](#tools-and-utilities)
8. [Examples](#examples)

---

## What are VistA MUMPS Globals?

**VistA MUMPS Globals** are persistent data structures used by the Veterans Affairs (VA) healthcare system to store patient information, clinical data, and administrative records. They represent a hierarchical database structure that has been used in VA hospitals for decades.

### Key Characteristics
- **Persistent Storage**: Data persists between system restarts
- **Hierarchical Structure**: Tree-like organization with multiple levels
- **Sparse Arrays**: Only defined nodes consume storage
- **Direct Access**: Efficient direct access to any node
- **Global Scope**: Accessible across all MUMPS processes

### Why Understanding VistA Globals Matters
- **Legacy System Integration**: Many VA facilities still use VistA
- **Data Migration Projects**: Moving from VistA to modern EHR systems
- **Clinical Data Analysis**: Understanding VA healthcare data structures
- **System Interoperability**: Interfacing with VA healthcare systems

---

## Global Structure and Syntax

### Basic Global Syntax

MUMPS globals use a specific syntax format:

```mumps
^GLOBAL_NAME(subscript1,subscript2,...)=value
```

**Components:**
- **`^`**: Indicates a global variable
- **`GLOBAL_NAME`**: The global identifier (usually 3-8 characters)
- **`(subscripts)`**: Hierarchical indexing (comma-separated)
- **`=value`**: The stored data value

### Example Global Entries

```mumps
^DPT(123,0)=DOE,JOHN M
^DPT(123,.02)=M
^DPT(123,.03)=2800115
^DPT(123,.09)=123456789
```

This represents:
- Patient IEN (Internal Entry Number): 123
- Record type: Patient Demographics (^DPT)
- Fields: Name, Gender, Date of Birth, SSN

### Subscript Levels

VistA globals can have multiple subscript levels:

```mumps
^GLOBAL(IEN,field,subfield,occurrence)=value
```

**Example Multi-level Structure:**
```mumps
^DPT(123,0)=DOE,JOHN M              # Main demographic record
^DPT(123,.02)=M                     # Gender field
^DPT(123,.11,1)=123 MAIN ST         # Address line 1
^DPT(123,.11,2)=APT 4B              # Address line 2
^DPT(123,.11,3)=ANYTOWN             # City
^DPT(123,.131,1,0)=555-123-4567     # Phone number
```

---

## Major VistA Globals

### 1. ^DPT - Patient Demographics

The Patient file contains basic demographic information:

```mumps
^DPT(IEN,field)=value
```

**Key Fields:**
- **0**: Main record (NAME^SEX^DOB^SSN^...)
- **.02**: Sex (M/F)  
- **.03**: Date of Birth (FileMan date format)
- **.09**: Social Security Number
- **.11**: Address (multiple subfields)
- **.13**: Phone numbers
- **.351**: Date of Death

**Example Patient Record:**
```mumps
^DPT(123,0)=DOE,JOHN MICHAEL^M^2800115^123456789^
^DPT(123,.02)=M
^DPT(123,.03)=2800115
^DPT(123,.09)=123456789
^DPT(123,.11,1)=123 MAIN STREET
^DPT(123,.11,3)=ANYTOWN
^DPT(123,.11,4)=VA
^DPT(123,.11,5)=12345
^DPT(123,.131,1,0)=555-123-4567^PRN^1^
```

### 2. ^DGPM - Patient Movement

Tracks patient admissions, discharges, and transfers:

```mumps
^DGPM(IEN,field)=value
```

**Key Fields:**
- **0**: Main record (PATIENT^ADMIT_DATE^TYPE^...)
- **.01**: Patient pointer to ^DPT
- **.02**: Admission Date/Time
- **.06**: Ward Location
- **.17**: Discharge Date/Time

**Example Movement Records:**
```mumps
^DGPM(456,0)=123^3231215.14^1^
^DGPM(456,.01)=123
^DGPM(456,.02)=3231215.14
^DGPM(456,.06)=ICU^101^A
^DGPM(456,.17)=3231217.1030
```

### 3. ^GMRD - Problem List

Stores patient problems and diagnoses:

```mumps
^GMRD(IEN,field)=value
```

**Example Problem Records:**
```mumps
^GMRD(789,0)=123^E11.9^ACTIVE^3231215
^GMRD(789,1,1,0)=TYPE 2 DIABETES MELLITUS
^GMRD(789,.08)=A
^GMRD(789,.12)=3231215
```

### 4. ^PS - Pharmacy/Prescriptions

Medication and prescription data:

```mumps
^PSRX(IEN,field)=value
```

**Example Prescription:**
```mumps
^PSRX(1001,0)=123^50^3231215^METFORMIN 500MG
^PSRX(1001,2)=500^MG^TAB
^PSRX(1001,6)=60^TABS
```

### 5. ^LAB - Laboratory Results

Laboratory test results and data:

```mumps
^LAB(IEN,field)=value
```

**Example Lab Results:**
```mumps
^LAB(2001,0)=123^GLUCOSE^3231215.14
^LAB(2001,.01)=123
^LAB(2001,.03)=95
^LAB(2001,.04)=MG/DL
^LAB(2001,3)=H
```

---

## Reading Global Files

### Understanding FileMan Date Format

VistA uses FileMan date format (days since December 31, 1840):

```python
def fileman_to_date(fileman_date):
    """Convert FileMan date to Python date"""
    if not fileman_date:
        return None
        
    # FileMan internal date format: YYYMMDD or YYYMMDD.HHMMSS
    date_str = str(fileman_date).split('.')[0]
    
    if len(date_str) == 7:  # YYYMMDD format
        century = int(date_str[0]) + 17  # FileMan century calculation
        year = century * 100 + int(date_str[1:3])
        month = int(date_str[3:5])
        day = int(date_str[5:7])
        
        return datetime(year, month, day).date()
    
    return None

# Example usage
fileman_date = 2800115  # January 15, 1980
python_date = fileman_to_date(fileman_date)
print(python_date)  # 1980-01-15
```

### Basic Global Parser

```python
import re
from typing import Dict, Any, List
from datetime import datetime, date

class VistAGlobalParser:
    def __init__(self):
        self.globals_data = {}
        
    def parse_global_file(self, filename: str) -> Dict[str, Any]:
        """Parse a VistA global export file"""
        with open(filename, 'r') as f:
            lines = f.readlines()
        
        for line in lines:
            line = line.strip()
            if line and '=' in line:
                self.parse_global_line(line)
        
        return self.globals_data
    
    def parse_global_line(self, line: str):
        """Parse a single global line"""
        try:
            # Split on first '=' to separate global reference and value
            global_ref, value = line.split('=', 1)
            
            # Parse global reference: ^GLOBAL(subscript1,subscript2,...)
            if global_ref.startswith('^'):
                global_parts = self.parse_global_reference(global_ref)
                
                if global_parts:
                    global_name = global_parts['name']
                    subscripts = global_parts['subscripts']
                    
                    # Initialize global structure
                    if global_name not in self.globals_data:
                        self.globals_data[global_name] = {}
                    
                    # Store data in nested structure
                    self.set_nested_value(self.globals_data[global_name], subscripts, value)
                    
        except Exception as e:
            print(f"Error parsing line: {line} - {e}")
    
    def parse_global_reference(self, global_ref: str) -> Dict[str, Any]:
        """Parse global reference into components"""
        # Pattern: ^GLOBAL_NAME(subscript1,subscript2,...)
        pattern = r'^\^([A-Z0-9]+)\((.*)\)$'
        match = re.match(pattern, global_ref)
        
        if match:
            global_name = match.group(1)
            subscripts_str = match.group(2)
            
            # Parse subscripts (handle quoted strings and numbers)
            subscripts = self.parse_subscripts(subscripts_str)
            
            return {
                'name': global_name,
                'subscripts': subscripts
            }
        
        return None
    
    def parse_subscripts(self, subscripts_str: str) -> List[str]:
        """Parse comma-separated subscripts"""
        subscripts = []
        current = ""
        in_quotes = False
        
        for char in subscripts_str:
            if char == '"' and not in_quotes:
                in_quotes = True
            elif char == '"' and in_quotes:
                in_quotes = False
            elif char == ',' and not in_quotes:
                subscripts.append(current.strip())
                current = ""
            else:
                current += char
        
        if current.strip():
            subscripts.append(current.strip())
        
        return subscripts
    
    def set_nested_value(self, data_dict: Dict, subscripts: List[str], value: str):
        """Set value in nested dictionary structure"""
        current = data_dict
        
        for i, subscript in enumerate(subscripts[:-1]):
            if subscript not in current:
                current[subscript] = {}
            current = current[subscript]
        
        # Set the final value
        if subscripts:
            current[subscripts[-1]] = value
    
    def get_patient_demographics(self, patient_ien: str) -> Dict[str, Any]:
        """Extract patient demographics from ^DPT global"""
        if 'DPT' not in self.globals_data or patient_ien not in self.globals_data['DPT']:
            return {}
        
        patient_data = self.globals_data['DPT'][patient_ien]
        demographics = {}
        
        # Parse main record (field 0)
        if '0' in patient_data:
            main_record = patient_data['0']
            # Format: NAME^SEX^DOB^SSN^...
            parts = main_record.split('^')
            if len(parts) > 0:
                demographics['name'] = parts[0]
            if len(parts) > 1:
                demographics['sex'] = parts[1]
            if len(parts) > 2:
                demographics['dob_fileman'] = parts[2]
                demographics['dob'] = self.fileman_to_date(parts[2])
            if len(parts) > 3:
                demographics['ssn'] = parts[3]
        
        # Individual fields override main record
        if '.02' in patient_data:
            demographics['sex'] = patient_data['.02']
        if '.03' in patient_data:
            demographics['dob_fileman'] = patient_data['.03']
            demographics['dob'] = self.fileman_to_date(patient_data['.03'])
        if '.09' in patient_data:
            demographics['ssn'] = patient_data['.09']
        
        # Address fields
        if '.11' in patient_data:
            address_data = patient_data['.11']
            address = {}
            if '1' in address_data:
                address['street1'] = address_data['1']
            if '2' in address_data:
                address['street2'] = address_data['2']
            if '3' in address_data:
                address['city'] = address_data['3']
            if '4' in address_data:
                address['state'] = address_data['4']
            if '5' in address_data:
                address['zip'] = address_data['5']
            demographics['address'] = address
        
        # Phone numbers
        if '.131' in patient_data:
            phone_data = patient_data['.131']
            phones = []
            for phone_num in phone_data:
                if isinstance(phone_data[phone_num], dict) and '0' in phone_data[phone_num]:
                    phone_record = phone_data[phone_num]['0']
                    phones.append(phone_record.split('^')[0])  # First part is phone number
            demographics['phones'] = phones
        
        return demographics
    
    def get_patient_movements(self, patient_ien: str) -> List[Dict[str, Any]]:
        """Extract patient movements from ^DGPM global"""
        movements = []
        
        if 'DGPM' not in self.globals_data:
            return movements
        
        for movement_ien, movement_data in self.globals_data['DGPM'].items():
            # Check if this movement belongs to the patient
            if '.01' in movement_data and movement_data['.01'] == patient_ien:
                movement = {
                    'movement_ien': movement_ien,
                    'patient_ien': patient_ien
                }
                
                if '.02' in movement_data:
                    movement['admit_date'] = self.fileman_to_datetime(movement_data['.02'])
                
                if '.06' in movement_data:
                    movement['ward_location'] = movement_data['.06']
                
                if '.17' in movement_data:
                    movement['discharge_date'] = self.fileman_to_datetime(movement_data['.17'])
                
                movements.append(movement)
        
        return sorted(movements, key=lambda x: x.get('admit_date', datetime.min))
    
    def fileman_to_date(self, fileman_date: str) -> date:
        """Convert FileMan date to Python date"""
        if not fileman_date:
            return None
        
        try:
            date_str = str(fileman_date).split('.')[0]
            
            if len(date_str) == 7:  # YYYMMDD format
                century = int(date_str[0]) + 17
                year = century * 100 + int(date_str[1:3])
                month = int(date_str[3:5])
                day = int(date_str[5:7])
                
                return date(year, month, day)
        except (ValueError, IndexError):
            pass
        
        return None
    
    def fileman_to_datetime(self, fileman_datetime: str) -> datetime:
        """Convert FileMan datetime to Python datetime"""
        if not fileman_datetime:
            return None
        
        try:
            parts = str(fileman_datetime).split('.')
            date_part = parts[0]
            time_part = parts[1] if len(parts) > 1 else "0000"
            
            # Parse date
            if len(date_part) == 7:  # YYYMMDD format
                century = int(date_part[0]) + 17
                year = century * 100 + int(date_part[1:3])
                month = int(date_part[3:5])
                day = int(date_part[5:7])
                
                # Parse time (HHMM or HHMMSS format)
                time_part = time_part.ljust(4, '0')  # Pad with zeros
                hour = int(time_part[:2]) if len(time_part) >= 2 else 0
                minute = int(time_part[2:4]) if len(time_part) >= 4 else 0
                second = int(time_part[4:6]) if len(time_part) >= 6 else 0
                
                return datetime(year, month, day, hour, minute, second)
        except (ValueError, IndexError):
            pass
        
        return None
```

---

## Working with VistA Data

### Example: Extract All Patients

```python
def extract_all_patients(global_file: str) -> List[Dict[str, Any]]:
    """Extract all patients from VistA global file"""
    parser = VistAGlobalParser()
    parser.parse_global_file(global_file)
    
    patients = []
    
    if 'DPT' in parser.globals_data:
        for patient_ien, patient_data in parser.globals_data['DPT'].items():
            demographics = parser.get_patient_demographics(patient_ien)
            movements = parser.get_patient_movements(patient_ien)
            
            patient_record = {
                'ien': patient_ien,
                'demographics': demographics,
                'movements': movements
            }
            
            patients.append(patient_record)
    
    return patients

# Usage
patients = extract_all_patients('vista_globals.mumps')
for patient in patients:
    print(f"Patient {patient['ien']}: {patient['demographics'].get('name', 'Unknown')}")
```

### Example: Convert to Modern Format

```python
def vista_to_fhir_patient(vista_patient: Dict[str, Any]) -> Dict[str, Any]:
    """Convert VistA patient data to FHIR Patient resource"""
    demographics = vista_patient.get('demographics', {})
    
    # Parse name
    name_parts = demographics.get('name', '').split(',')
    family_name = name_parts[0] if len(name_parts) > 0 else ''
    given_names = name_parts[1].strip().split() if len(name_parts) > 1 else []
    
    fhir_patient = {
        'resourceType': 'Patient',
        'id': f"vista-{vista_patient['ien']}",
        'identifier': [
            {
                'use': 'usual',
                'type': {
                    'coding': [{
                        'system': 'http://terminology.hl7.org/CodeSystem/v2-0203',
                        'code': 'MR'
                    }]
                },
                'system': 'https://va.gov/vista-ien',
                'value': vista_patient['ien']
            }
        ],
        'name': [{
            'use': 'official',
            'family': family_name,
            'given': given_names
        }]
    }
    
    # Add SSN if present
    if demographics.get('ssn'):
        fhir_patient['identifier'].append({
            'use': 'official',
            'type': {
                'coding': [{
                    'system': 'http://terminology.hl7.org/CodeSystem/v2-0203',
                    'code': 'SS'
                }]
            },
            'system': 'http://hl7.org/fhir/sid/us-ssn',
            'value': demographics['ssn']
        })
    
    # Add gender
    if demographics.get('sex'):
        gender_map = {'M': 'male', 'F': 'female'}
        fhir_patient['gender'] = gender_map.get(demographics['sex'], 'unknown')
    
    # Add birth date
    if demographics.get('dob'):
        fhir_patient['birthDate'] = demographics['dob'].isoformat()
    
    # Add address
    if demographics.get('address'):
        addr = demographics['address']
        address = {
            'use': 'home',
            'type': 'physical',
            'line': []
        }
        
        if addr.get('street1'):
            address['line'].append(addr['street1'])
        if addr.get('street2'):
            address['line'].append(addr['street2'])
        if addr.get('city'):
            address['city'] = addr['city']
        if addr.get('state'):
            address['state'] = addr['state']
        if addr.get('zip'):
            address['postalCode'] = addr['zip']
        
        fhir_patient['address'] = [address]
    
    # Add phone numbers
    if demographics.get('phones'):
        fhir_patient['telecom'] = []
        for phone in demographics['phones']:
            fhir_patient['telecom'].append({
                'system': 'phone',
                'value': phone,
                'use': 'home'
            })
    
    return fhir_patient

# Usage
vista_patients = extract_all_patients('vista_globals.mumps')
fhir_patients = []

for vista_patient in vista_patients:
    fhir_patient = vista_to_fhir_patient(vista_patient)
    fhir_patients.append(fhir_patient)

print(f"Converted {len(fhir_patients)} patients to FHIR format")
```

---

## Common Global Patterns

### 1. Multiple Occurrence Fields

Many VistA fields can have multiple values:

```mumps
^DPT(123,.131,1,0)=555-123-4567^PRN^1^
^DPT(123,.131,2,0)=555-987-6543^WRK^2^
^DPT(123,.131,3,0)=555-555-1212^CEL^3^
```

### 2. Cross-References

VistA uses cross-references for indexing:

```mumps
^DPT("B","DOE,JOHN M",123)=""
^DPT("SSN",123456789,123)=""
^DPT("ADOB",2800115,123)=""
```

### 3. Pointer Fields

Fields that reference other files:

```mumps
^DGPM(456,.01)=123    # Points to ^DPT(123)
^DGPM(456,.06)=ICU    # Points to ward location file
```

### 4. Date/Time Storage

FileMan dates can include time:

```mumps
^DGPM(456,.02)=3231215.1430    # Dec 15, 2023 at 2:30 PM
```

---

## Tools and Utilities

### VistA Global Export Utilities

```python
class VistAExporter:
    def __init__(self, parser: VistAGlobalParser):
        self.parser = parser
    
    def export_to_csv(self, output_dir: str):
        """Export VistA data to CSV files"""
        import csv
        import os
        
        os.makedirs(output_dir, exist_ok=True)
        
        # Export patients
        patients = []
        if 'DPT' in self.parser.globals_data:
            for ien, data in self.parser.globals_data['DPT'].items():
                demographics = self.parser.get_patient_demographics(ien)
                patients.append({
                    'ien': ien,
                    'name': demographics.get('name', ''),
                    'sex': demographics.get('sex', ''),
                    'dob': str(demographics.get('dob', '')),
                    'ssn': demographics.get('ssn', ''),
                    'city': demographics.get('address', {}).get('city', ''),
                    'state': demographics.get('address', {}).get('state', ''),
                    'zip': demographics.get('address', {}).get('zip', '')
                })
        
        with open(f"{output_dir}/patients.csv", 'w', newline='') as f:
            if patients:
                writer = csv.DictWriter(f, fieldnames=patients[0].keys())
                writer.writeheader()
                writer.writerows(patients)
        
        # Export movements
        movements = []
        if 'DGPM' in self.parser.globals_data:
            for ien, data in self.parser.globals_data['DGPM'].items():
                movement = {
                    'movement_ien': ien,
                    'patient_ien': data.get('.01', ''),
                    'admit_date': str(self.parser.fileman_to_datetime(data.get('.02', ''))),
                    'ward': data.get('.06', ''),
                    'discharge_date': str(self.parser.fileman_to_datetime(data.get('.17', '')))
                }
                movements.append(movement)
        
        with open(f"{output_dir}/movements.csv", 'w', newline='') as f:
            if movements:
                writer = csv.DictWriter(f, fieldnames=movements[0].keys())
                writer.writeheader()
                writer.writerows(movements)
    
    def export_to_json(self, filename: str):
        """Export parsed data to JSON"""
        import json
        
        # Convert to serializable format
        export_data = {
            'patients': [],
            'movements': [],
            'metadata': {
                'export_date': datetime.now().isoformat(),
                'total_patients': 0,
                'total_movements': 0
            }
        }
        
        # Extract patients
        if 'DPT' in self.parser.globals_data:
            for ien, data in self.parser.globals_data['DPT'].items():
                demographics = self.parser.get_patient_demographics(ien)
                # Convert dates to strings for JSON serialization
                if 'dob' in demographics and demographics['dob']:
                    demographics['dob'] = demographics['dob'].isoformat()
                
                patient_record = {
                    'ien': ien,
                    'demographics': demographics,
                    'movements': self.parser.get_patient_movements(ien)
                }
                
                # Convert datetime objects to strings
                for movement in patient_record['movements']:
                    for key, value in movement.items():
                        if isinstance(value, datetime):
                            movement[key] = value.isoformat()
                        elif isinstance(value, date):
                            movement[key] = value.isoformat()
                
                export_data['patients'].append(patient_record)
            
            export_data['metadata']['total_patients'] = len(export_data['patients'])
        
        with open(filename, 'w') as f:
            json.dump(export_data, f, indent=2)
```

### Global File Validation

```python
def validate_vista_global_file(filename: str) -> Dict[str, Any]:
    """Validate VistA global file format"""
    validation_result = {
        'valid': True,
        'errors': [],
        'warnings': [],
        'statistics': {
            'total_lines': 0,
            'valid_lines': 0,
            'invalid_lines': 0,
            'globals_found': set(),
            'patients_found': 0
        }
    }
    
    try:
        with open(filename, 'r') as f:
            lines = f.readlines()
        
        validation_result['statistics']['total_lines'] = len(lines)
        
        for i, line in enumerate(lines, 1):
            line = line.strip()
            if not line:
                continue
            
            # Check global format
            if not line.startswith('^'):
                validation_result['errors'].append(f"Line {i}: Does not start with '^': {line[:50]}")
                validation_result['statistics']['invalid_lines'] += 1
                continue
            
            if '=' not in line:
                validation_result['errors'].append(f"Line {i}: Missing '=' separator: {line[:50]}")
                validation_result['statistics']['invalid_lines'] += 1
                continue
            
            # Parse global name
            global_ref = line.split('=')[0]
            global_match = re.match(r'^\^([A-Z0-9]+)', global_ref)
            if global_match:
                global_name = global_match.group(1)
                validation_result['statistics']['globals_found'].add(global_name)
                
                # Count patients
                if global_name == 'DPT':
                    validation_result['statistics']['patients_found'] += 1
            else:
                validation_result['errors'].append(f"Line {i}: Invalid global format: {global_ref}")
                validation_result['statistics']['invalid_lines'] += 1
                continue
            
            validation_result['statistics']['valid_lines'] += 1
        
        # Check for expected globals
        expected_globals = ['DPT']  # At minimum, should have patient data
        for expected in expected_globals:
            if expected not in validation_result['statistics']['globals_found']:
                validation_result['warnings'].append(f"Expected global ^{expected} not found")
        
        # Overall validation status
        if validation_result['errors']:
            validation_result['valid'] = False
        
    except Exception as e:
        validation_result['valid'] = False
        validation_result['errors'].append(f"File reading error: {str(e)}")
    
    return validation_result
```

---

## Examples

### Example 1: Patient Census Report

```python
def generate_patient_census(global_file: str) -> str:
    """Generate patient census report from VistA globals"""
    parser = VistAGlobalParser()
    parser.parse_global_file(global_file)
    
    patients = extract_all_patients(global_file)
    
    # Generate statistics
    total_patients = len(patients)
    gender_stats = {'M': 0, 'F': 0, 'Unknown': 0}
    age_groups = {'0-18': 0, '19-40': 0, '41-65': 0, '66+': 0, 'Unknown': 0}
    
    today = date.today()
    
    for patient in patients:
        demographics = patient['demographics']
        
        # Gender statistics
        gender = demographics.get('sex', 'Unknown')
        gender_stats[gender] = gender_stats.get(gender, 0) + 1
        
        # Age statistics
        birth_date = demographics.get('dob')
        if birth_date:
            age = (today - birth_date).days // 365
            if age <= 18:
                age_groups['0-18'] += 1
            elif age <= 40:
                age_groups['19-40'] += 1
            elif age <= 65:
                age_groups['41-65'] += 1
            else:
                age_groups['66+'] += 1
        else:
            age_groups['Unknown'] += 1
    
    # Generate report
    report = f"""
VistA Patient Census Report
===========================

Total Patients: {total_patients}

Gender Distribution:
-------------------
Male: {gender_stats.get('M', 0)} ({gender_stats.get('M', 0)/total_patients*100:.1f}%)
Female: {gender_stats.get('F', 0)} ({gender_stats.get('F', 0)/total_patients*100:.1f}%)
Unknown: {gender_stats.get('Unknown', 0)} ({gender_stats.get('Unknown', 0)/total_patients*100:.1f}%)

Age Distribution:
----------------
0-18: {age_groups['0-18']} ({age_groups['0-18']/total_patients*100:.1f}%)
19-40: {age_groups['19-40']} ({age_groups['19-40']/total_patients*100:.1f}%)
41-65: {age_groups['41-65']} ({age_groups['41-65']/total_patients*100:.1f}%)
66+: {age_groups['66+']} ({age_groups['66+']/total_patients*100:.1f}%)
Unknown: {age_groups['Unknown']} ({age_groups['Unknown']/total_patients*100:.1f}%)

Sample Patients:
---------------
"""
    
    # Add sample patient records
    for patient in patients[:5]:  # Show first 5 patients
        demographics = patient['demographics']
        name = demographics.get('name', 'Unknown')
        dob = demographics.get('dob', 'Unknown')
        sex = demographics.get('sex', 'Unknown')
        
        report += f"  {name} - DOB: {dob}, Gender: {sex}\n"
    
    return report

# Usage
report = generate_patient_census('vista_globals.mumps')
print(report)
```

### Example 2: Migration Data Quality Check

```python
def check_migration_data_quality(global_file: str) -> Dict[str, Any]:
    """Check data quality for VistA migration"""
    parser = VistAGlobalParser()
    parser.parse_global_file(global_file)
    
    quality_report = {
        'total_patients': 0,
        'data_quality_issues': [],
        'completeness_stats': {
            'name': 0,
            'ssn': 0,
            'dob': 0,
            'gender': 0,
            'address': 0
        },
        'validation_errors': []
    }
    
    patients = extract_all_patients(global_file)
    quality_report['total_patients'] = len(patients)
    
    for patient in patients:
        ien = patient['ien']
        demographics = patient['demographics']
        
        # Check completeness
        if demographics.get('name'):
            quality_report['completeness_stats']['name'] += 1
        else:
            quality_report['data_quality_issues'].append(f"Patient {ien}: Missing name")
        
        if demographics.get('ssn'):
            quality_report['completeness_stats']['ssn'] += 1
            # Validate SSN format
            ssn = demographics['ssn']
            if not re.match(r'^\d{9}$', ssn):
                quality_report['validation_errors'].append(f"Patient {ien}: Invalid SSN format: {ssn}")
        else:
            quality_report['data_quality_issues'].append(f"Patient {ien}: Missing SSN")
        
        if demographics.get('dob'):
            quality_report['completeness_stats']['dob'] += 1
            # Check for future dates
            if demographics['dob'] > date.today():
                quality_report['validation_errors'].append(f"Patient {ien}: Future birth date: {demographics['dob']}")
        else:
            quality_report['data_quality_issues'].append(f"Patient {ien}: Missing date of birth")
        
        if demographics.get('sex'):
            quality_report['completeness_stats']['gender'] += 1
            # Validate gender values
            if demographics['sex'] not in ['M', 'F']:
                quality_report['validation_errors'].append(f"Patient {ien}: Invalid gender: {demographics['sex']}")
        else:
            quality_report['data_quality_issues'].append(f"Patient {ien}: Missing gender")
        
        if demographics.get('address'):
            quality_report['completeness_stats']['address'] += 1
        else:
            quality_report['data_quality_issues'].append(f"Patient {ien}: Missing address")
    
    # Calculate completion percentages
    total = quality_report['total_patients']
    if total > 0:
        for field, count in quality_report['completeness_stats'].items():
            quality_report['completeness_stats'][f'{field}_percentage'] = (count / total) * 100
    
    return quality_report

# Usage
quality_check = check_migration_data_quality('vista_globals.mumps')
print(f"Data Quality Summary:")
print(f"Total Patients: {quality_check['total_patients']}")
print(f"Data Issues: {len(quality_check['data_quality_issues'])}")
print(f"Validation Errors: {len(quality_check['validation_errors'])}")
print(f"Name Completeness: {quality_check['completeness_stats'].get('name_percentage', 0):.1f}%")
```

### Example 3: Convert VistA to Modern Database

```python
import sqlite3

def vista_to_sqlite(global_file: str, db_file: str):
    """Convert VistA globals to SQLite database"""
    parser = VistAGlobalParser()
    parser.parse_global_file(global_file)
    
    # Create SQLite database
    conn = sqlite3.connect(db_file)
    cursor = conn.cursor()
    
    # Create tables
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS patients (
            ien TEXT PRIMARY KEY,
            name TEXT,
            first_name TEXT,
            last_name TEXT,
            sex TEXT,
            birth_date TEXT,
            ssn TEXT,
            street1 TEXT,
            street2 TEXT,
            city TEXT,
            state TEXT,
            zip TEXT
        )
    ''')
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS movements (
            movement_ien TEXT PRIMARY KEY,
            patient_ien TEXT,
            admit_date TEXT,
            ward_location TEXT,
            discharge_date TEXT,
            FOREIGN KEY (patient_ien) REFERENCES patients (ien)
        )
    ''')
    
    # Insert patient data
    patients = extract_all_patients(global_file)
    
    for patient in patients:
        ien = patient['ien']
        demographics = patient['demographics']
        
        # Parse name
        name = demographics.get('name', '')
        name_parts = name.split(',')
        last_name = name_parts[0] if len(name_parts) > 0 else ''
        first_name = name_parts[1].strip() if len(name_parts) > 1 else ''
        
        # Address
        address = demographics.get('address', {})
        
        cursor.execute('''
            INSERT OR REPLACE INTO patients 
            (ien, name, first_name, last_name, sex, birth_date, ssn, 
             street1, street2, city, state, zip)
            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
        ''', (
            ien,
            name,
            first_name,
            last_name,
            demographics.get('sex', ''),
            str(demographics.get('dob', '')),
            demographics.get('ssn', ''),
            address.get('street1', ''),
            address.get('street2', ''),
            address.get('city', ''),
            address.get('state', ''),
            address.get('zip', '')
        ))
        
        # Insert movements
        for movement in patient['movements']:
            cursor.execute('''
                INSERT OR REPLACE INTO movements
                (movement_ien, patient_ien, admit_date, ward_location, discharge_date)
                VALUES (?, ?, ?, ?, ?)
            ''', (
                movement['movement_ien'],
                movement['patient_ien'],
                str(movement.get('admit_date', '')),
                movement.get('ward_location', ''),
                str(movement.get('discharge_date', ''))
            ))
    
    conn.commit()
    conn.close()
    
    print(f"VistA data converted to SQLite database: {db_file}")
    print(f"Processed {len(patients)} patients")

# Usage
vista_to_sqlite('vista_globals.mumps', 'vista_data.db')

# Query the database
conn = sqlite3.connect('vista_data.db')
cursor = conn.cursor()

cursor.execute('SELECT COUNT(*) FROM patients')
patient_count = cursor.fetchone()[0]

cursor.execute('SELECT COUNT(*) FROM movements')  
movement_count = cursor.fetchone()[0]

print(f"Database contains {patient_count} patients and {movement_count} movements")

conn.close()
```

---

## Best Practices

### Reading VistA Globals
1. **Understand FileMan date format** - Always convert to standard dates
2. **Handle missing fields gracefully** - Not all fields are always populated
3. **Parse cross-references correctly** - Index entries vs. data entries
4. **Validate data consistency** - Check for logical inconsistencies

### Performance Considerations
```python
# Use generators for large files
def parse_vista_globals_streaming(filename):
    with open(filename, 'r') as f:
        for line in f:
            if line.strip() and '=' in line:
                yield parse_global_line(line.strip())
```

### Error Handling
```python
def safe_parse_vista_date(date_str):
    try:
        return fileman_to_date(date_str)
    except (ValueError, AttributeError):
        return None
```

### Migration Considerations
1. **Preserve original IENs** for reference tracking
2. **Validate data integrity** during conversion
3. **Handle duplicate records** appropriately
4. **Maintain audit trails** of conversion process

This comprehensive primer provides the foundation for understanding and working with VistA MUMPS global structures in healthcare data migration and analysis projects.