# FHIR Bundle Primer: Understanding and Working with FHIR R4 Resources

## Overview

FHIR (Fast Healthcare Interoperability Resources) R4 is the latest standard for healthcare data exchange. This primer explains how to read, understand, and work with FHIR Bundle files generated by the Synthetic Healthcare Data Generator.

## Table of Contents

1. [What is FHIR?](#what-is-fhir)
2. [FHIR Bundle Structure](#fhir-bundle-structure)
3. [Reading FHIR Resources](#reading-fhir-resources)
4. [Common Resource Types](#common-resource-types)
5. [Working with FHIR Data](#working-with-fhir-data)
6. [Tools and Libraries](#tools-and-libraries)
7. [Examples](#examples)

---

## What is FHIR?

**FHIR (Fast Healthcare Interoperability Resources)** is a healthcare data exchange standard developed by HL7 International. It defines:

- **Resources**: Standard data structures for healthcare concepts (Patient, Condition, Medication, etc.)
- **RESTful APIs**: HTTP-based interfaces for data exchange
- **Terminology**: Standard vocabularies and code systems
- **Profiles**: Constraints for specific use cases (like US Core)

### Key Benefits
- **Interoperability**: Standardized format across different systems
- **Modern Technology**: Uses JSON, REST APIs, and web standards
- **Extensible**: Can be customized for specific needs
- **Clinical Focus**: Designed by healthcare professionals

---

## FHIR Bundle Structure

A FHIR Bundle is a container that holds multiple FHIR resources together. Our generator creates **Collection Bundles** containing patient data.

### Basic Bundle Structure

```json
{
  "resourceType": "Bundle",
  "type": "collection",
  "timestamp": "2023-12-15T10:30:00Z",
  "entry": [
    {
      "resource": {
        // Individual FHIR Resource (Patient, Condition, etc.)
      }
    },
    {
      "resource": {
        // Another FHIR Resource
      }
    }
  ]
}
```

### Bundle Types
- **collection**: A set of resources assembled for convenience
- **searchset**: Resources returned from a search operation
- **transaction**: Resources to be processed as a transaction
- **document**: A document bundle (like a clinical document)

---

## Reading FHIR Resources

### Basic Resource Structure

Every FHIR resource has a common structure:

```json
{
  "resourceType": "ResourceName",  // Type of resource (Patient, Condition, etc.)
  "id": "unique-identifier",       // Unique ID for this resource
  "meta": {                        // Metadata about the resource
    "profile": ["profile-url"]     // Conformance profiles this resource follows
  },
  // Resource-specific fields...
}
```

### Key Elements
- **resourceType**: Identifies what kind of resource this is
- **id**: Unique identifier within the system
- **meta**: Technical metadata (profiles, version, etc.)
- **identifier**: Business identifiers (MRN, SSN, etc.)

### Data Types

FHIR uses specific data types:

| Data Type | Description | Example |
|-----------|-------------|---------|
| **string** | Text data | `"John Doe"` |
| **date** | Date only | `"1980-01-15"` |
| **dateTime** | Date and time | `"2023-12-15T10:30:00Z"` |
| **boolean** | True/false | `true` |
| **integer** | Whole number | `42` |
| **decimal** | Decimal number | `98.6` |
| **CodeableConcept** | Coded value | See below |
| **Reference** | Link to another resource | `{"reference": "Patient/123"}` |

### CodeableConcept Structure

Medical concepts in FHIR use CodeableConcept:

```json
{
  "coding": [
    {
      "system": "http://snomed.info/sct",
      "code": "44054006",
      "display": "Diabetes mellitus"
    },
    {
      "system": "http://hl7.org/fhir/sid/icd-10-cm",
      "code": "E11.9",
      "display": "Type 2 diabetes mellitus without complications"
    }
  ],
  "text": "Diabetes"
}
```

---

## Common Resource Types

### 1. Patient Resource

Contains demographic and administrative information:

```json
{
  "resourceType": "Patient",
  "id": "patient-123",
  "meta": {
    "profile": ["http://hl7.org/fhir/us/core/StructureDefinition/us-core-patient"]
  },
  "identifier": [
    {
      "use": "usual",
      "type": {
        "coding": [{
          "system": "http://terminology.hl7.org/CodeSystem/v2-0203",
          "code": "MR"
        }]
      },
      "system": "https://hospital.example.com/patient-id",
      "value": "MRN123456"
    }
  ],
  "name": [
    {
      "use": "official",
      "family": "Doe",
      "given": ["John", "Michael"]
    }
  ],
  "gender": "male",
  "birthDate": "1980-01-15",
  "address": [
    {
      "use": "home",
      "line": ["123 Main Street"],
      "city": "Anytown",
      "state": "VA",
      "postalCode": "12345",
      "country": "US"
    }
  ],
  "telecom": [
    {
      "system": "phone",
      "value": "555-123-4567",
      "use": "home"
    }
  ]
}
```

**Key Fields:**
- **identifier**: Business identifiers (MRN, SSN, etc.)
- **name**: Patient name(s)
- **gender**: Administrative gender
- **birthDate**: Date of birth
- **address**: Contact addresses
- **telecom**: Phone numbers, email addresses

### 2. Condition Resource

Represents diagnoses, problems, or health conditions:

```json
{
  "resourceType": "Condition",
  "id": "condition-456",
  "subject": {
    "reference": "Patient/patient-123"
  },
  "code": {
    "coding": [
      {
        "system": "http://snomed.info/sct",
        "code": "44054006",
        "display": "Diabetes mellitus"
      },
      {
        "system": "http://hl7.org/fhir/sid/icd-10-cm",
        "code": "E11.9",
        "display": "Type 2 diabetes mellitus without complications"
      }
    ],
    "text": "Type 2 Diabetes"
  },
  "clinicalStatus": {
    "coding": [{
      "system": "http://terminology.hl7.org/CodeSystem/condition-clinical",
      "code": "active"
    }]
  },
  "verificationStatus": {
    "coding": [{
      "system": "http://terminology.hl7.org/CodeSystem/condition-ver-status",
      "code": "confirmed"
    }]
  },
  "onsetDateTime": "2020-03-15"
}
```

**Key Fields:**
- **subject**: Reference to the patient
- **code**: The condition/diagnosis (coded)
- **clinicalStatus**: active, inactive, resolved, etc.
- **verificationStatus**: confirmed, provisional, etc.
- **onsetDateTime**: When the condition started

### 3. Medication Resource

Represents medications and prescriptions:

```json
{
  "resourceType": "MedicationRequest",
  "id": "medication-789",
  "status": "active",
  "subject": {
    "reference": "Patient/patient-123"
  },
  "medicationCodeableConcept": {
    "coding": [
      {
        "system": "http://www.nlm.nih.gov/research/umls/rxnorm",
        "code": "6809",
        "display": "Metformin"
      }
    ],
    "text": "Metformin 500mg"
  },
  "dosageInstruction": [
    {
      "text": "Take 500mg twice daily with meals",
      "timing": {
        "repeat": {
          "frequency": 2,
          "period": 1,
          "periodUnit": "d"
        }
      },
      "doseAndRate": [
        {
          "doseQuantity": {
            "value": 500,
            "unit": "mg"
          }
        }
      ]
    }
  ]
}
```

---

## Working with FHIR Data

### Reading FHIR Bundle Files

#### Using Python

```python
import json

# Read FHIR bundle
with open('fhir_bundle.json', 'r') as f:
    bundle = json.load(f)

# Access bundle metadata
print(f"Bundle type: {bundle['type']}")
print(f"Number of entries: {len(bundle['entry'])}")

# Iterate through resources
for entry in bundle['entry']:
    resource = entry['resource']
    resource_type = resource['resourceType']
    resource_id = resource.get('id', 'Unknown')
    
    print(f"Resource: {resource_type} (ID: {resource_id})")
    
    # Process specific resource types
    if resource_type == 'Patient':
        name = resource['name'][0]
        full_name = f"{name['given'][0]} {name['family']}"
        print(f"  Patient Name: {full_name}")
        
    elif resource_type == 'Condition':
        condition_text = resource['code']['text']
        status = resource['clinicalStatus']['coding'][0]['code']
        print(f"  Condition: {condition_text} ({status})")
```

#### Using JavaScript/Node.js

```javascript
const fs = require('fs');

// Read FHIR bundle
const bundle = JSON.parse(fs.readFileSync('fhir_bundle.json', 'utf8'));

// Process resources
bundle.entry.forEach(entry => {
    const resource = entry.resource;
    
    if (resource.resourceType === 'Patient') {
        const name = resource.name[0];
        const fullName = `${name.given.join(' ')} ${name.family}`;
        console.log(`Patient: ${fullName}`);
        
    } else if (resource.resourceType === 'Condition') {
        const conditionName = resource.code.text;
        const status = resource.clinicalStatus.coding[0].code;
        console.log(`Condition: ${conditionName} (${status})`);
    }
});
```

### Extracting Specific Data

#### Get All Patients

```python
def get_patients(bundle):
    patients = []
    for entry in bundle['entry']:
        resource = entry['resource']
        if resource['resourceType'] == 'Patient':
            patients.append(resource)
    return patients
```

#### Get Conditions for a Patient

```python
def get_patient_conditions(bundle, patient_id):
    conditions = []
    patient_reference = f"Patient/{patient_id}"
    
    for entry in bundle['entry']:
        resource = entry['resource']
        if (resource['resourceType'] == 'Condition' and
            resource['subject']['reference'] == patient_reference):
            conditions.append(resource)
    
    return conditions
```

#### Extract Coded Values

```python
def extract_codes(codeable_concept):
    codes = {}
    for coding in codeable_concept.get('coding', []):
        system = coding['system']
        code = coding['code']
        display = coding.get('display', '')
        
        if 'snomed' in system:
            codes['snomed'] = {'code': code, 'display': display}
        elif 'icd-10' in system:
            codes['icd10'] = {'code': code, 'display': display}
    
    return codes
```

---

## Tools and Libraries

### Python Libraries

1. **fhir.resources**
   ```bash
   pip install fhir.resources
   ```
   
   ```python
   from fhir.resources.bundle import Bundle
   from fhir.resources.patient import Patient
   
   # Parse and validate FHIR resources
   bundle = Bundle.parse_file('fhir_bundle.json')
   
   for entry in bundle.entry:
       if entry.resource.resource_type == 'Patient':
           patient = Patient(**entry.resource.dict())
           print(f"Patient: {patient.name[0].given[0]} {patient.name[0].family}")
   ```

2. **fhirclient**
   ```bash
   pip install fhirclient
   ```

### JavaScript Libraries

1. **@types/fhir**
   ```bash
   npm install @types/fhir
   ```

2. **fhir-kit-client**
   ```bash
   npm install fhir-kit-client
   ```

### Online Tools

1. **FHIR Validator**: https://validator.fhir.org/
2. **FHIR Path Tester**: http://hl7.org/fhirpath/
3. **Simplifier.net**: https://simplifier.net/ (FHIR profiles and implementation guides)

---

## Examples

### Example 1: Patient Demographics Analysis

```python
import json
from datetime import datetime

def analyze_patient_demographics(bundle_file):
    with open(bundle_file, 'r') as f:
        bundle = json.load(f)
    
    demographics = {
        'total_patients': 0,
        'gender_distribution': {},
        'age_groups': {'0-18': 0, '19-40': 0, '41-65': 0, '66+': 0}
    }
    
    for entry in bundle['entry']:
        resource = entry['resource']
        if resource['resourceType'] == 'Patient':
            demographics['total_patients'] += 1
            
            # Gender distribution
            gender = resource.get('gender', 'unknown')
            demographics['gender_distribution'][gender] = \
                demographics['gender_distribution'].get(gender, 0) + 1
            
            # Age calculation
            if 'birthDate' in resource:
                birth_date = datetime.strptime(resource['birthDate'], '%Y-%m-%d')
                age = (datetime.now() - birth_date).days // 365
                
                if age <= 18:
                    demographics['age_groups']['0-18'] += 1
                elif age <= 40:
                    demographics['age_groups']['19-40'] += 1
                elif age <= 65:
                    demographics['age_groups']['41-65'] += 1
                else:
                    demographics['age_groups']['66+'] += 1
    
    return demographics

# Usage
demographics = analyze_patient_demographics('fhir_bundle.json')
print(f"Total patients: {demographics['total_patients']}")
print(f"Gender distribution: {demographics['gender_distribution']}")
print(f"Age groups: {demographics['age_groups']}")
```

### Example 2: Condition Analysis

```python
def analyze_conditions(bundle_file):
    with open(bundle_file, 'r') as f:
        bundle = json.load(f)
    
    condition_stats = {}
    
    for entry in bundle['entry']:
        resource = entry['resource']
        if resource['resourceType'] == 'Condition':
            condition_text = resource['code']['text']
            
            if condition_text not in condition_stats:
                condition_stats[condition_text] = {
                    'count': 0,
                    'active': 0,
                    'resolved': 0,
                    'codes': {}
                }
            
            condition_stats[condition_text]['count'] += 1
            
            # Status analysis
            status = resource['clinicalStatus']['coding'][0]['code']
            if status == 'active':
                condition_stats[condition_text]['active'] += 1
            elif status == 'resolved':
                condition_stats[condition_text]['resolved'] += 1
            
            # Collect coding systems
            for coding in resource['code']['coding']:
                system = coding['system']
                code = coding['code']
                condition_stats[condition_text]['codes'][system] = code
    
    return condition_stats

# Usage
conditions = analyze_conditions('fhir_bundle.json')
for condition, stats in conditions.items():
    print(f"{condition}: {stats['count']} patients ({stats['active']} active)")
```

### Example 3: Converting to CSV

```python
import csv
import json

def fhir_to_csv(bundle_file, output_file):
    with open(bundle_file, 'r') as f:
        bundle = json.load(f)
    
    patients = []
    
    for entry in bundle['entry']:
        resource = entry['resource']
        if resource['resourceType'] == 'Patient':
            patient_data = {
                'id': resource['id'],
                'family_name': resource['name'][0]['family'],
                'given_name': ' '.join(resource['name'][0]['given']),
                'gender': resource.get('gender', ''),
                'birth_date': resource.get('birthDate', ''),
                'city': resource['address'][0]['city'] if resource.get('address') else '',
                'state': resource['address'][0]['state'] if resource.get('address') else '',
                'postal_code': resource['address'][0]['postalCode'] if resource.get('address') else ''
            }
            patients.append(patient_data)
    
    # Write to CSV
    with open(output_file, 'w', newline='') as csvfile:
        fieldnames = ['id', 'family_name', 'given_name', 'gender', 'birth_date', 
                     'city', 'state', 'postal_code']
        writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
        writer.writeheader()
        writer.writerows(patients)

# Usage
fhir_to_csv('fhir_bundle.json', 'patients.csv')
```

---

## Best Practices

### Reading FHIR Data
1. **Always check resourceType** before processing
2. **Handle missing fields gracefully** using `.get()` methods
3. **Validate data structure** before accessing nested fields
4. **Use proper libraries** for validation and parsing

### Working with Codes
1. **Understand multiple coding systems** (SNOMED, ICD-10, etc.)
2. **Check for both code and display** values
3. **Use text field as fallback** if coded values aren't sufficient

### Error Handling
```python
def safe_extract_patient_name(patient_resource):
    try:
        name = patient_resource['name'][0]
        family = name.get('family', 'Unknown')
        given = ' '.join(name.get('given', ['Unknown']))
        return f"{given} {family}"
    except (KeyError, IndexError):
        return "Name not available"
```

This primer provides a comprehensive foundation for understanding and working with FHIR Bundle files generated by the healthcare data generator.